<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Package Editor - World Travel Admin</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea2a33",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211111",
                        "surface-dark": "#1a0f0f",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-[#1b0e0e] dark:text-white h-screen overflow-hidden flex font-display">

    <!-- Main Content (Full Width for Editor) -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Header -->
        <header
            class="h-20 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-surface-dark flex items-center justify-between px-8 shrink-0">
            <div class="flex flex-col">
                <div class="flex items-center gap-2 text-sm text-gray-500 mb-1">
                    <span class="hover:text-primary cursor-pointer transition-colors"
                        onclick="window.location.href='dashboard.html'">Dashboard</span>
                    <span class="material-symbols-outlined text-[12px]">chevron_right</span>
                    <span class="hover:text-primary cursor-pointer transition-colors"
                        onclick="window.location.href='packages.html'">Packages</span>
                    <span class="material-symbols-outlined text-[12px]">chevron_right</span>
                    <span class="font-medium text-gray-900 dark:text-gray-100" id="header-breadcrumb">New Package</span>
                </div>
                <h2 class="text-xl font-bold text-[#1b0e0e] dark:text-white" id="header-title">Create New Package</h2>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='packages.html'"
                    class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 transition-colors">
                    Cancel
                </button>
                <button form="package-form" type="submit"
                    class="flex items-center gap-2 h-10 px-6 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm font-bold transition-all shadow-sm hover:shadow-md">
                    <span class="material-symbols-outlined text-[20px]">save</span>
                    <span>Save Package</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8 bg-background-light dark:bg-background-dark">
            <div class="max-w-4xl mx-auto">

                <form id="package-form" class="space-y-8">

                    <!-- Basic Info -->
                    <div
                        class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">feed</span> Basic Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold mb-2">Package Title</label>
                                <input type="text" id="title" required
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., Everest Base Camp Trek">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Slug (URL)</label>
                                <input type="text" id="slug" required
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., everest-base-camp">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Price ($)</label>
                                <input type="number" id="price" required
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., 2500">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Duration</label>
                                <input type="text" id="duration" required
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., 14 Days">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Group Size</label>
                                <input type="text" id="group_size"
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., Max 12">
                            </div>
                        </div>
                    </div>

                    <!-- Images -->
                    <div
                        class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">image</span> Images
                        </h3>

                        <div id="image-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <!-- Previews injected here -->
                        </div>

                        <div class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl p-8 text-center hover:border-primary/50 transition-colors cursor-pointer"
                            onclick="document.getElementById('image-upload').click()">
                            <input type="file" id="image-upload" multiple class="hidden" accept="image/*">
                            <span class="material-symbols-outlined text-4xl text-gray-300 mb-2">cloud_upload</span>
                            <p class="text-sm font-medium text-gray-500">Click to upload images</p>
                            <p class="text-xs text-gray-400 mt-1">JPG, PNG up to 2MB</p>
                        </div>
                        <input type="hidden" id="images-json" value="[]">
                    </div>

                    <!-- Departure & Return -->
                    <div
                        class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">flight_takeoff</span> Departure &
                            Logistics
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold mb-2">Departure Point</label>
                                <input type="text" id="departure_location"
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., Tribhuvan International Airport">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Departure Time</label>
                                <input type="text" id="departure_time"
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="e.g., 6:30 AM">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold mb-2">Pickup Details</label>
                                <textarea id="pickup_details" rows="2"
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="Instructions for pickup..."></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold mb-2">Video URL (e.g., YouTube/Vimeo)</label>
                                <input type="url" id="video_url"
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                        </div>
                    </div>

                    <!-- Itinerary Builder -->
                    <div
                        class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6">
                        <h3 class="text-lg font-bold mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">map</span> Itinerary
                            </div>
                            <button type="button" onclick="addItineraryStep()"
                                class="text-sm text-primary font-bold hover:underline">+ Add Stop</button>
                        </h3>

                        <div id="itinerary-container" class="space-y-4">
                            <!-- Steps injected here -->
                        </div>
                    </div>

                    <!-- Details -->
                    <div
                        class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">description</span> Details
                        </h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold mb-2">Overview</label>
                                <textarea id="overview" rows="4"
                                    class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                    placeholder="Detailed description of the tour..."></textarea>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-green-600">Included (One per
                                        line)</label>
                                    <textarea id="included" rows="6"
                                        class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                        placeholder="Airport transfers&#10;Accommodation"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-red-500">Excluded (One per
                                        line)</label>
                                    <textarea id="excluded" rows="6"
                                        class="w-full rounded-lg border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-white/5 focus:border-primary focus:ring-primary/20 dark:text-white"
                                        placeholder="Gratuities&#10;Personal expenses"></textarea>
                                </div>
                            </div>

                            <div class="flex items-center gap-3 pt-4 border-t border-gray-100 dark:border-white/5">
                                <input type="checkbox" id="is_featured"
                                    class="rounded border-gray-300 text-primary focus:ring-primary">
                                <label for="is_featured" class="text-sm font-medium">Feature this package on
                                    Homepage</label>
                            </div>
                        </div>
                    </div>

                </form>

            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="toast"
        class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-24 transition-transform duration-300 z-50 flex items-center gap-3">
        <span class="material-symbols-outlined text-green-400">check_circle</span>
        <span id="toast-msg">Saved Successfully</span>
    </div>

    <!-- Supabase Logic -->
    <script>
        const supabaseUrl = 'https://piiffvqqfecuejqyiqmf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpaWZmdnFxZmVjdWVqcXlpcW1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDkyNzAsImV4cCI6MjA4MzcyNTI3MH0.YYv6Ws3f9WjUvwc-Gl-_TEThQTYkC86ed3tjw176Huc';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const urlParams = new URLSearchParams(window.location.search);
        const packageId = urlParams.get('id');
        let currentImages = [];
        let itinerarySteps = [];

        // Auth Check
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) window.location.href = 'index.html';
        }
        checkSession();

        // Initialize Editor
        async function init() {
            if (packageId) {
                // Edit Mode
                document.getElementById('header-title').innerText = 'Edit Package';
                document.getElementById('header-breadcrumb').innerText = 'Edit';

                const { data, error } = await supabaseClient.from('packages').select('*').eq('id', packageId).single();

                if (data) {
                    document.getElementById('title').value = data.title;
                    document.getElementById('slug').value = data.slug;
                    document.getElementById('price').value = data.price;
                    document.getElementById('duration').value = data.duration;
                    document.getElementById('group_size').value = data.group_size;
                    document.getElementById('overview').value = data.overview;

                    document.getElementById('departure_location').value = data.departure_location || '';
                    document.getElementById('departure_time').value = data.departure_time || '';
                    document.getElementById('pickup_details').value = data.pickup_details || '';
                    document.getElementById('video_url').value = data.video_url || '';

                    document.getElementById('included').value = Array.isArray(data.included) ? data.included.join('\n') : data.included;
                    document.getElementById('excluded').value = Array.isArray(data.excluded) ? data.excluded.join('\n') : (data.excluded || '');

                    document.getElementById('is_featured').checked = data.is_featured;

                    if (data.images) {
                        currentImages = data.images;
                        renderImages();
                    }
                    if (data.itinerary) {
                        itinerarySteps = data.itinerary;
                        renderItinerary();
                    }
                }
            } else {
                // Add one mock step to start
                addItineraryStep();
            }
        }
        init();

        // Itinerary Handlers
        window.addItineraryStep = () => {
            itinerarySteps.push({ title: '', duration: '', description: '' });
            renderItinerary();
        }

        window.removeItineraryStep = (index) => {
            itinerarySteps.splice(index, 1);
            renderItinerary();
        }

        window.updateItineraryStep = (index, field, value) => {
            itinerarySteps[index][field] = value;
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = itinerarySteps.map((step, index) => `
                <div class="flex gap-4 items-start group">
                    <div class="flex flex-col items-center gap-1 mt-2">
                         <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs font-bold">${index + 1}</div>
                         <div class="w-0.5 h-full bg-gray-200 group-last:hidden"></div>
                    </div>
                    <div class="flex-1 bg-gray-50 dark:bg-white/5 rounded-lg p-4 border border-gray-100 dark:border-white/5 space-y-3">
                        <div class="flex gap-4">
                            <input type="text" onchange="updateItineraryStep(${index}, 'title', this.value)" value="${step.title || ''}" class="flex-1 rounded border-gray-200 dark:border-gray-700 dark:bg-black/20 text-sm font-bold" placeholder="Step Title (e.g. Flight to Lukla)">
                            <input type="text" onchange="updateItineraryStep(${index}, 'duration', this.value)" value="${step.duration || ''}" class="w-32 rounded border-gray-200 dark:border-gray-700 dark:bg-black/20 text-sm" placeholder="Duration">
                        </div>
                        <textarea onchange="updateItineraryStep(${index}, 'description', this.value)" rows="2" class="w-full rounded border-gray-200 dark:border-gray-700 dark:bg-black/20 text-sm text-gray-600" placeholder="Description...">${step.description || ''}</textarea>
                        <button type="button" onclick="removeItineraryStep(${index})" class="text-xs text-red-500 hover:text-red-700 hover:underline">Remove Step</button>
                    </div>
                </div>
            `).join('');
        }

        // Image Handling
        document.getElementById('image-upload').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;

            // TODO: Implement Real Storage Uploads
            // For now, we will simulate by creating object URLs for preview and warning user
            // In a real app, you would upload to Supabase Storage bucket 'package-images' and get public URL

            // Mock Upload for now (since we haven't set up buckets via tool yet)
            // Ideally: await uploadImage(file) -> url

            for (let file of files) {
                // Simulate upload by using a fake URL or simple data URI if small
                // Note: For persistent storage, we need the bucket.
                // Because I can't guarantee one-shot Setup of storage, I'll use a placeholder logic:
                // If they are real files, I'll try to use a dummy image service or just warn.

                // Let's use a placeholder approach for this demo or try to upload if bucket exists
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentImages.push(e.target.result); // Data URI (Heavy for DB, but works for demo small images)
                    renderImages();
                }
                reader.readAsDataURL(file);
            }
        });

        function renderImages() {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = currentImages.map((img, index) => `
                <div class="relative aspect-video bg-gray-100 rounded-lg overflow-hidden group">
                    <img src="${img}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-[16px]">close</span>
                    </button>
                </div>
            `).join('');
        }

        window.removeImage = (index) => {
            currentImages.splice(index, 1);
            renderImages();
        };

        // Form Submit
        document.getElementById('package-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                title: document.getElementById('title').value,
                slug: document.getElementById('slug').value,
                price: parseFloat(document.getElementById('price').value),
                duration: document.getElementById('duration').value,
                group_size: document.getElementById('group_size').value,
                overview: document.getElementById('overview').value,
                departure_location: document.getElementById('departure_location').value,
                departure_time: document.getElementById('departure_time').value,
                pickup_details: document.getElementById('pickup_details').value,
                video_url: document.getElementById('video_url').value,
                included: document.getElementById('included').value.split('\n').filter(line => line.trim() !== ''),
                excluded: document.getElementById('excluded').value.split('\n').filter(line => line.trim() !== ''),
                is_featured: document.getElementById('is_featured').checked,
                images: currentImages,
                itinerary: itinerarySteps
            };

            let error;
            if (packageId) {
                const { error: err } = await supabaseClient.from('packages').update(formData).eq('id', packageId);
                error = err;
            } else {
                const { error: err } = await supabaseClient.from('packages').insert([formData]);
                error = err;
            }

            if (error) {
                alert('Error: ' + error.message);
            } else {
                showToast('Package saved successfully!');
                setTimeout(() => window.location.href = 'packages.html', 1500);
            }
        });

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('translate-y-24');
            setTimeout(() => toast.classList.add('translate-y-24'), 3000);
        }

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - World Travel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-shrink-0 hidden lg:flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-slate-700">
            <h1 class="text-xl font-bold uppercase tracking-wider">World Travel</h1>
        </div>
        <nav class="flex-1 py-6 px-3 space-y-1">
            <a href="#" class="flex items-center gap-3 px-3 py-2 bg-blue-600 rounded-lg text-white font-medium"
                id="nav-dashboard">
                <span class="material-symbols-outlined">dashboard</span>
                Dashboard
            </a>
            <a href="#"
                class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors font-medium cursor-pointer"
                id="nav-packages">
                <span class="material-symbols-outlined">inventory_2</span>
                Packages
            </a>
            <a href="#"
                class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors font-medium cursor-pointer"
                id="nav-inquiries">
                <span class="material-symbols-outlined">mail</span>
                Inquiries
            </a>
            <a href="../index.html" target="_blank"
                class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors font-medium mt-8">
                <span class="material-symbols-outlined">public</span>
                View Website
            </a>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <button id="logout-btn"
                class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm font-medium">
                <span class="material-symbols-outlined text-[18px]">logout</span>
                Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0">
        <!-- Top Header for Mobile -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 lg:hidden">
            <div class="font-bold text-slate-900">Admin Panel</div>
            <button class="text-slate-500 hover:text-slate-700">
                <span class="material-symbols-outlined">menu</span>
            </button>
        </header>

        <div class="p-6 lg:p-10 flex-1 overflow-y-auto">

            <!-- Dashboard View -->
            <div id="view-dashboard" class="space-y-8">
                <h2 class="text-2xl font-bold text-slate-800">Overview</h2>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div
                        class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Packages</p>
                            <h3 class="text-3xl font-bold text-slate-900" id="stat-packages">0</h3>
                        </div>
                        <div class="bg-blue-50 text-blue-600 p-3 rounded-lg">
                            <span class="material-symbols-outlined">inventory_2</span>
                        </div>
                    </div>
                    <div
                        class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">New Inquiries</p>
                            <h3 class="text-3xl font-bold text-slate-900" id="stat-inquiries">0</h3>
                        </div>
                        <div class="bg-emerald-50 text-emerald-600 p-3 rounded-lg">
                            <span class="material-symbols-outlined">mail</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activities (Placeholder) -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Recent Inquiries</h3>
                        <a href="#" class="text-blue-600 text-sm font-bold hover:underline">View All</a>
                    </div>
                    <div class="divide-y divide-slate-100" id="recent-inquiries-list">
                        <!-- Items will be injected here -->
                        <div class="p-6 text-center text-slate-500 text-sm">Loading data...</div>
                    </div>
                </div>
            </div>

            <!-- Packages View (Hidden by default) -->
            <div id="view-packages" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Packages Management</h2>
                    <button
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
                        onclick="openPackageModal()">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                        New Package
                    </button>
                </div>

                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr
                                class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b border-slate-200">
                                <th class="px-6 py-4">Title</th>
                                <th class="px-6 py-4">Price</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="packages-list">
                            <!-- Package rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Supabase Logic -->
    <script>
        const supabaseUrl = 'https://piiffvqqfecuejqyiqmf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpaWZmdnFxZmVjdWVqcXlpcW1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDkyNzAsImV4cCI6MjA4MzcyNTI3MH0.YYv6Ws3f9WjUvwc-Gl-_TEThQTYkC86ed3tjw176Huc';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Security: Check Session
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
            }
        }
        checkSession();

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });

        // Navigation Logic
        const views = {
            'dashboard': document.getElementById('view-dashboard'),
            'packages': document.getElementById('view-packages')
        };

        document.querySelectorAll('nav a[id^="nav-"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // Reset styling
                document.querySelectorAll('nav a').forEach(l => l.classList.remove('bg-blue-600', 'text-white'));
                document.querySelectorAll('nav a').forEach(l => l.classList.add('text-slate-400'));

                // Active styling
                e.currentTarget.classList.remove('text-slate-400');
                e.currentTarget.classList.add('bg-blue-600', 'text-white');

                // Show view
                const viewName = e.currentTarget.id.replace('nav-', '');
                Object.values(views).forEach(el => el && el.classList.add('hidden'));
                if (views[viewName]) views[viewName].classList.remove('hidden');
            });
        });

        // Real Data Fetching
        async function fetchStats() {
            const { count: packageCount } = await supabaseClient.from('packages').select('*', { count: 'exact', head: true });
            const { count: inquiryCount } = await supabaseClient.from('inquiries').select('*', { count: 'exact', head: true }).eq('status', 'new');

            document.getElementById('stat-packages').innerText = packageCount || 0;
            document.getElementById('stat-inquiries').innerText = inquiryCount || 0;
        }

        async function fetchRecentInquiries() {
            const { data, error } = await supabaseClient
                .from('inquiries')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            const container = document.getElementById('recent-inquiries-list');
            if (data && data.length > 0) {
                container.innerHTML = data.map(inquiry => `
                    <div class="px-6 py-4 hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-slate-800">${inquiry.company || inquiry.name}</h4>
                            <span class="text-xs text-slate-400">${new Date(inquiry.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-1">From: ${inquiry.name} (${inquiry.email})</p>
                        <p class="text-sm text-slate-600 truncate">${inquiry.message || 'No message provided'}</p>
                        <div class="mt-2 flex gap-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${inquiry.status === 'new' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'} capitalize">${inquiry.status}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="p-6 text-center text-slate-500 text-sm">No recent inquiries found.</div>';
            }
        }

        async function fetchPackages() {
            const { data, error } = await supabaseClient
                .from('packages')
                .select('*')
                .order('created_at', { ascending: false });

            const container = document.getElementById('packages-list');
            if (data && data.length > 0) {
                container.innerHTML = data.map(pkg => `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-50 text-indigo-600 p-2 rounded-lg">
                                    <span class="material-symbols-outlined">inventory_2</span>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">${pkg.title}</div>
                                    <div class="text-xs text-slate-500">/${pkg.slug}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-600 font-medium">$${pkg.price?.toLocaleString()}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${pkg.is_featured ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">
                                ${pkg.is_featured ? 'Featured' : 'Standard'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button class="text-blue-600 hover:text-blue-800 font-bold text-xs mr-3">Edit</button>
                            <button class="text-red-500 hover:text-red-700 font-bold text-xs">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                container.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">No packages found. Create one to get started.</td></tr>';
            }
        }

        // Initialize
        fetchStats();
        fetchRecentInquiries();
        fetchPackages();

        // Polling for updates (demo purpose)
        setInterval(() => {
            fetchStats();
            // fetchRecentInquiries(); // Optional: polling logic
        }, 10000);
    </script>
</body>

</html>